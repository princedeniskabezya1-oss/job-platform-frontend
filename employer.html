<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employer Dashboard | AIFT</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#0a66c2;
  --bg:#f3f2ef;
  --card:#ffffff;
  --text:#1c1c1c;
  --muted:#6f6f6f;
  --border:#e0e0e0;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body{background:var(--bg);}

/* HEADER */
.header{
  background:white;
  padding:15px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.logo{
  font-weight:800;
  font-size:22px;
}
.logo span{color:var(--primary);}
.header-buttons button{
  margin-left:10px;
}

/* BUTTON */
button{
  background:var(--primary);
  color:white;
  border:none;
  padding:8px 16px;
  border-radius:20px;
  cursor:pointer;
  font-weight:600;
}

/* LAYOUT */
.container{
  display:grid;
  grid-template-columns:260px 1fr 300px;
  gap:20px;
  max-width:1300px;
  margin:40px auto;
}

/* CARD */
.card{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);
  margin-bottom:20px;
}

/* PROFILE */
.profile-banner{
  width:100%;
  height:120px;
  background:#ddd;
  border-radius:10px;
  object-fit:cover;
}
.profile-image{
  width:90px;
  height:90px;
  border-radius:50%;
  border:4px solid white;
  margin-top:-45px;
  object-fit:cover;
}

/* TOOL LINKS */
.tool-link{
  padding:10px 0;
  border-bottom:1px solid var(--border);
  cursor:pointer;
  font-size:14px;
}
.tool-link:hover{color:var(--primary);}

/* POSTS */
.post-box textarea{
  width:100%;
  border:none;
  resize:none;
  outline:none;
  font-size:15px;
}

.post-media img,
.post-media video{
  width:100%;
  border-radius:10px;
  margin-top:10px;
}

.post-actions{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
}

.post-footer{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
  font-size:14px;
  color:var(--muted);
}

.icon-btn{
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
}
.icon-btn:hover{color:var(--primary);}
.comment-box input{
  width:100%;
  padding:8px;
  border-radius:20px;
  border:1px solid var(--border);
  margin-top:8px;
}

/* RIGHT STATS */
.stat{
  margin-bottom:8px;
  font-size:14px;
}
.stat b{color:var(--text);}
</style>
</head>

<body>

<div class="header">

  <div style="display:flex;align-items:center;gap:30px;">

    <div class="logo"><span>AI</span>FT Employer</div>

    <!-- SEARCH BAR -->
    <div style="position:relative;">
      <input type="text" id="globalSearch"
             placeholder="Search candidates, jobs..."
             style="width:300px;padding:8px 35px 8px 12px;border-radius:20px;border:1px solid #ddd;">
      <span style="position:absolute;right:10px;top:7px;font-size:14px;color:#6f6f6f;">üîç</span>
    </div>

  </div>

  <!-- RIGHT SIDE ICONS -->
  <div style="display:flex;align-items:center;gap:25px;">

    <!-- Messages -->
    <div style="cursor:pointer;" onclick="openMessages()">
      üí¨ <span style="font-size:12px;">Messages</span>
    </div>

    <!-- Notifications -->
    <div style="cursor:pointer;position:relative;" onclick="openNotifications()">
      üîî <span style="font-size:12px;">Notifications</span>
      <span id="notificationCount"
            style="position:absolute;top:-5px;right:-10px;background:red;color:white;
                   font-size:10px;padding:2px 6px;border-radius:50%;">
        0
      </span>
    </div>

    <!-- Profile Thumbnail -->
    <div onclick="window.location.href='profile.html'"
         style="display:flex;align-items:center;gap:8px;cursor:pointer;">
      <img id="topProfileImg"
           src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
           style="width:32px;height:32px;border-radius:50%;">
      <span id="topProfileName" style="font-size:14px;"></span>
    </div>

  </div>

</div>


<div class="container">

<!-- LEFT COLUMN -->
<div>

  <div class="card" id="profileCard"></div>

  <div class="card">
    <h3>Employer Tools</h3>
    <div class="tool-link" onclick="window.location.href='post-job.html'">‚ûï Post New Job</div>
    <div class="tool-link" onclick="showMyJobs()">üìÑ My Jobs (<span id="jobCount">0</span>)</div>
    <div class="tool-link" onclick="showApplications()">üì© Applications (<span id="appCount">0</span>)</div>
  </div>

</div>

<!-- CENTER COLUMN -->
<div>

  <!-- FEED PANEL -->
  <div id="feedPanel">

<div class="card post-box">

  <textarea id="postContent" rows="3" placeholder="Share company update..."></textarea>

  <div id="filePreviewContainer" style="margin-top:10px;"></div>

  <div class="post-actions" style="align-items:center;">

    <label style="cursor:pointer;color:#0a66c2;font-weight:600;">
      üìé Add Media
      <input type="file" id="mediaInput" accept="image/*,video/*" style="display:none;">
    </label>

    <button id="postBtn" onclick="createPost()">Post</button>

  </div>

</div>

    <div id="posts"></div>

  </div>

  <!-- DYNAMIC TOOL PANEL -->
  <div id="toolPanel" style="display:none;"></div>

</div>


<!-- RIGHT COLUMN -->
<div>

  <div class="card">
    <h3>Company Stats</h3>
    <div class="stat">Followers: <b id="followers">0</b></div>
    <div class="stat">Following: <b id="following">0</b></div>
    <div class="stat">Pro Status: <b id="proStatus">Free</b></div>
    <hr style="margin:10px 0;">
    <div class="stat">Total Jobs: <b id="totalJobs">0</b></div>
    <div class="stat">Active Jobs: <b id="activeJobs">0</b></div>
    <div class="stat">Applications: <b id="totalApplications">0</b></div>
  </div>

</div>

</div>

<script>
const API="https://backend-1-9b6f.onrender.com";
const token=localStorage.getItem("token");
if(!token) window.location.href="login.html";

/* PROFILE */
async function loadProfile(){
  const res=await fetch(API+"/api/users/me",{headers:{Authorization:"Bearer "+token}});
  const user=await res.json();

document.getElementById("profileCard").innerHTML=`
  <img class="profile-banner" src="${user.bannerImage || 'https://via.placeholder.com/600x120'}">

  <input type="file" id="bannerUpload" onchange="updateProfile()" style="margin-top:5px;">

  <img class="profile-image" src="${user.profileImage || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}">

  <input type="file" id="profileUpload" onchange="updateProfile()" style="margin-top:5px;">

  <h3>${user.name}</h3>
  <div style="color:#6f6f6f;font-size:14px;">${user.headline || ''}</div>
`;

  document.getElementById("followers").innerText=user.followers?.length||0;
  document.getElementById("following").innerText=user.following?.length||0;
  document.getElementById("proStatus").innerText=user.isPro?"Pro":"Free";
  document.getElementById("topProfileImg").src =
  user.profileImage || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

document.getElementById("topProfileName").innerText = user.name;
}
async function updateProfile(){

  const formData = new FormData();

  const profileFile = document.getElementById("profileUpload")?.files[0];
  const bannerFile = document.getElementById("bannerUpload")?.files[0];

  if(profileFile){
    formData.append("profileImage", profileFile);
  }

  if(bannerFile){
    formData.append("bannerImage", bannerFile);
  }

  await fetch(API+"/api/users/profile",{
    method:"PATCH",
    headers:{ Authorization:"Bearer "+token },
    body:formData
  });

  loadProfile();
}
/* POSTS */
async function loadPosts(){

  try{

    const res=await fetch(API+"/api/posts",{
      headers:{ Authorization:"Bearer "+token }
    });

    if(!res.ok){
      console.error("Post load failed:",res.status);
      return;
    }

    const posts=await res.json();
    const container=document.getElementById("posts");
    container.innerHTML="";

    if(posts.length===0){
      container.innerHTML=`
        <div class="card">
          <div style="color:#6f6f6f;">No posts yet.</div>
        </div>
      `;
      return;
    }

let html = "";

posts.forEach(post=>{
  html += `
        <div class="card">

          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <img src="${post.author?.profileImage || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                 style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
            <div>
              <b>${post.author?.name || 'User'}</b>
              <div style="font-size:12px;color:#6f6f6f;">
                ${post.author?.headline || ""}
              </div>
            </div>
          </div>

          <div>${post.content || ""}</div>

          ${post.mediaUrl ? `
            <div class="post-media">
              ${post.mediaType==="video"
                ? `<video controls src="${post.mediaUrl}"></video>`
                : `<img src="${post.mediaUrl}">`}
            </div>
          ` : ""}

<div class="post-footer">
  <div data-like="${post._id}">${post.likes.length} likes</div>

  <div style="display:flex;gap:15px;">
<div class="icon-btn" onclick="likePost('${post._id}')">
  ${post.likes.some(id => id === localStorage.getItem("userId")) ? "üíô Liked" : "‚ù§Ô∏è Like"}
</div>

    <div class="icon-btn" onclick="toggleCommentBox('${post._id}')">
      üí¨ Comment
    </div>

    <div class="icon-btn" onclick="sharePost('${post._id}')">
      üîÅ Share
    </div>
  </div>
</div>

<div id="comment-section-${post._id}" style="margin-top:10px;">
  ${post.comments.map(c => `
    <div style="margin-bottom:8px;">
      <b>${c.user?.name || "User"}</b>
      <div style="font-size:13px;">${c.text}</div>
    </div>
  `).join("")}
</div>

<div style="margin-top:8px;">
  <input 
    type="text"
    placeholder="Write a comment..."
    onkeydown="if(event.key==='Enter'){ addComment('${post._id}', this.value); this.value=''; }"
    style="width:100%;padding:8px;border-radius:20px;border:1px solid #ddd;"
  >
</div>

        </div>
      `;
    });
    container.innerHTML = html;

  }catch(err){
    console.error(err);
  }
}
document.getElementById("mediaInput").addEventListener("change", function(){

  const file = this.files[0];
  const previewContainer = document.getElementById("filePreviewContainer");

  previewContainer.innerHTML = "";

  if(!file) return;

  if(file.type.startsWith("image")){
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.style.width = "100%";
    img.style.borderRadius = "10px";
    img.style.marginTop = "10px";
    previewContainer.appendChild(img);

  }else if(file.type.startsWith("video")){
    const video = document.createElement("video");
    video.src = URL.createObjectURL(file);
    video.controls = true;
    video.style.width = "100%";
    video.style.borderRadius = "10px";
    video.style.marginTop = "10px";
    previewContainer.appendChild(video);
  }

});

/* CREATE POST */
async function createPost(){

  const content = document.getElementById("postContent").value.trim();
  const fileInput = document.getElementById("mediaInput");
  const file = fileInput.files[0];
  const postBtn = document.getElementById("postBtn");

  if(!content && !file){
    alert("Please add text or media.");
    return;
  }

  const formData = new FormData();
  formData.append("content", content);

  if(file){
    formData.append("media", file);
  }

  try{

    postBtn.innerText = "Posting...";
    postBtn.disabled = true;

    const res = await fetch(API + "/api/posts", {
      method: "POST",
      headers: { Authorization: "Bearer " + token },
      body: formData
    });

    if(!res.ok){
      const err = await res.text();
      alert("Error: " + err);
      postBtn.innerText = "Post";
      postBtn.disabled = false;
      return;
    }

    // Clear fields
    document.getElementById("postContent").value = "";
    fileInput.value = "";
    document.getElementById("filePreviewContainer").innerHTML = "";

    postBtn.innerText = "Post";
    postBtn.disabled = false;

    await loadPosts();

  }catch(err){
    console.error(err);
    alert("Post failed");
    postBtn.innerText = "Post";
    postBtn.disabled = false;
  }
}


/* LIKE */
async function likePost(id){

  const res=await fetch(API+"/api/posts/"+id+"/like",{
    method:"PATCH",
    headers:{Authorization:"Bearer "+token}
  });

  const data=await res.json();

  const likeElement=document.querySelector(`[data-like="${id}"]`);
  if(likeElement){
    likeElement.innerText=data.likes+" likes";
  }
}


/* JOB STATS */
async function loadEmployerStats(){

  try{

    const jobsRes=await fetch(API+"/api/jobs/my",{
      headers:{Authorization:"Bearer "+token}
    });

    const jobs=jobsRes.ok?await jobsRes.json():[];

    document.getElementById("jobCount").innerText=jobs.length;
    document.getElementById("totalJobs").innerText=jobs.length;
    document.getElementById("activeJobs").innerText=
      jobs.filter(j=>j.status==="active").length;

    const appsRes=await fetch(API+"/api/applications",{
      headers:{Authorization:"Bearer "+token}
    });

    const apps=appsRes.ok?await appsRes.json():[];

    document.getElementById("appCount").innerText=apps.length;
    document.getElementById("totalApplications").innerText=apps.length;

  }catch(err){
    console.error("Stats error:",err);
  }
}


async function showMyJobs(){

  document.getElementById("feedPanel").style.display="none";
  document.getElementById("toolPanel").style.display="block";

  const res=await fetch(API+"/api/jobs/my",{headers:{Authorization:"Bearer "+token}});
  const jobs=res.ok?await res.json():[];

  let html=`
    <div class="card">
      <h3>My Jobs</h3>
  `;

  jobs.forEach(job=>{
    html+=`
      <div style="border-bottom:1px solid #eee;padding:10px 0;">
        <b>${job.title}</b>
        <div style="font-size:13px;color:#6f6f6f;">
          Status: ${job.status}
        </div>

        <div style="margin-top:6px;">
          <button onclick="editJob('${job._id}','${job.title}')">Edit</button>
          <button style="background:#e53935;" onclick="deleteJob('${job._id}')">Delete</button>
        </div>
      </div>
    `;
  });
  html+=`
  <div style="margin-top:20px;">
    <button onclick="backToFeed()">‚¨Ö Back to Feed</button>
  </div>
`;


  html+=`</div>`;

  document.getElementById("toolPanel").innerHTML=html;
}
function openMessages(){

  document.getElementById("feedPanel").style.display="none";
  document.getElementById("toolPanel").style.display="block";

  document.getElementById("toolPanel").innerHTML=`
    <div class="card">
      <h3>Messages</h3>
      <p style="color:#6f6f6f;font-size:14px;">
        No messages yet.
      </p>
      <button onclick="backToFeed()">‚¨Ö Back to Feed</button>
    </div>
  `;
}


function openNotifications(){
  alert("Notifications system coming soon.");
}

async function editJob(id,currentTitle){

  const newTitle=prompt("Edit Job Title:",currentTitle);
  if(!newTitle) return;

  await fetch(API+"/api/jobs/"+id,{
    method:"PATCH",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({title:newTitle})
  });

  showMyJobs();
}
  async function addComment(postId, text){

  if(!text.trim()) return;

  await fetch(API+"/api/posts/"+postId+"/comment",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({ text })
  });

  loadPosts();
}

function toggleCommentBox(id){
  // optional animation later
}

async function sharePost(id){

  await fetch(API+"/api/posts/"+id+"/share",{
    method:"POST",
    headers:{ Authorization:"Bearer "+token }
  });

  loadPosts();
}
  /*
=====================================================
SHARE POST
=====================================================
*/
router.post("/:id/share", auth, async (req, res) => {
  try {

    const original = await Post.findById(req.params.id);

    if(!original){
      return res.status(404).json({ message:"Post not found" });
    }

    const sharedPost = new Post({
      author: req.user.id,
      content: original.content,
      mediaUrl: original.mediaUrl,
      mediaType: original.mediaType
    });

    await sharedPost.save();

    res.json({ message:"Post shared" });

  } catch(err){
    res.status(400).json({ message:"Share failed" });
  }
});

async function deleteJob(id){

  if(!confirm("Delete this job?")) return;

  await fetch(API+"/api/jobs/"+id,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token}
  });

  showMyJobs();
}

async function showApplications(){

  document.getElementById("feedPanel").style.display="none";
  document.getElementById("toolPanel").style.display="block";

  const res=await fetch(API+"/api/applications",{headers:{Authorization:"Bearer "+token}});
  const apps=res.ok?await res.json():[];

  let html=`
    <div class="card">
      <h3>Applications</h3>

      <input type="text" id="filterInput"
             placeholder="Filter candidates..."
             style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:15px;"
             onkeyup="filterCandidates()">

      <div id="appList">
  `;

  apps.forEach(app=>{
    html+=`
      <div class="candidate-row"
           data-name="${app.name}"
           style="border-bottom:1px solid #eee;padding:10px 0;">

        <b>${app.name}</b>
        <div style="font-size:13px;color:#6f6f6f;">
          Applied for: ${app.jobId?.title || ''}
        </div>

        <div style="margin-top:5px;">
          <button onclick="shortlist('${app._id}')">‚≠ê Shortlist</button>
        </div>

      </div>
    `;
  });
html+=`
  <div style="margin-top:20px;">
    <button onclick="backToFeed()">‚¨Ö Back to Feed</button>
  </div>
`;

  html+=`</div></div>`;

  document.getElementById("toolPanel").innerHTML=html;
}
function filterCandidates(){
  const value=document.getElementById("filterInput").value.toLowerCase();

  document.querySelectorAll(".candidate-row").forEach(row=>{
    const name=row.getAttribute("data-name").toLowerCase();
    row.style.display=name.includes(value)?"block":"none";
  });
}

async function shortlist(id){

  await fetch(API+"/api/applications/"+id+"/shortlist",{
    method:"PATCH",
    headers:{Authorization:"Bearer "+token}
  });

  alert("Candidate shortlisted");
}
function backToFeed(){
  document.getElementById("toolPanel").style.display="none";
  document.getElementById("feedPanel").style.display="block";
}

function logout(){localStorage.removeItem("token");window.location.href="login.html";}

document.addEventListener("DOMContentLoaded", function(){
  loadProfile();
  loadPosts();
  loadEmployerStats();
});
</script>

</body>
</html>
