<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Profile | AIFT</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#fafafa;
}

.container{
  max-width:1000px;
  margin:40px auto;
  padding:0 20px;
}

/* ================= HEADER ================= */

.profile-header{
  display:flex;
  align-items:center;
  gap:60px;
  padding-bottom:30px;
  border-bottom:1px solid #dbdbdb;
}

.avatar{
  width:140px;
  height:140px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #eee;
}

.profile-info{
  flex:1;
}

.top-row{
  display:flex;
  align-items:center;
  gap:20px;
}

.top-row h2{
  margin:0;
  font-weight:600;
  font-size:24px;
}

.btn{
  padding:6px 18px;
  border-radius:8px;
  border:none;
  font-weight:600;
  cursor:pointer;
  font-size:14px;
}

.follow-btn{
  background:#0095f6;
  color:white;
}

.unfollow-btn{
  background:#efefef;
}

.message-btn{
  background:#efefef;
}

.stats{
  margin-top:15px;
  display:flex;
  gap:30px;
  font-size:15px;
}

.stats span{
  cursor:pointer;
}

.bio{
  margin-top:15px;
  font-size:14px;
  line-height:1.5;
}

/* ================= POSTS GRID ================= */

.posts-grid{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:4px;
  margin-top:30px;
}

.posts-grid img,
.posts-grid video{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  cursor:pointer;
  transition:0.2s;
}

.posts-grid img:hover,
.posts-grid video:hover{
  opacity:0.85;
}

/* ================= RESPONSIVE ================= */

@media(max-width:768px){
  .profile-header{
    flex-direction:column;
    gap:20px;
    align-items:flex-start;
  }

  .posts-grid{
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>

<body>

<div class="container">

  <!-- PROFILE HEADER -->
  <div class="profile-header">

    <img id="avatar" class="avatar">

    <div class="profile-info">

      <div class="top-row">
        <h2 id="name"></h2>

        <button id="followBtn" class="btn follow-btn" onclick="toggleFollow()">Follow</button>
        <button class="btn message-btn" onclick="messageUser()">Message</button>
      </div>

      <div class="stats">
        <span><strong id="postsCount">0</strong> posts</span>
        <span><strong id="followersCount">0</strong> followers</span>
        <span><strong id="followingCount">0</strong> following</span>
      </div>

      <div class="bio">
        <strong id="role"></strong><br>
        <span id="headline"></span><br>
        <span id="bioText"></span>
      </div>

    </div>

  </div>

  <!-- POSTS GRID -->
  <div class="posts-grid" id="userPosts"></div>

</div>

<script>
const API="https://backend-1-9b6f.onrender.com";
const token=localStorage.getItem("token");

const params=new URLSearchParams(window.location.search);
const userId=params.get("id");

if(!userId) window.location.href="employer.html";

/* ================= LOAD PROFILE ================= */

async function loadProfile(){

  const res=await fetch(API+"/api/users/"+userId+"/public");
  const user=await res.json();

  document.getElementById("avatar").src =
    user.profileImage || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

  document.getElementById("name").innerText=user.name;
  document.getElementById("headline").innerText=user.headline || "";
  document.getElementById("bioText").innerText=user.bio || "";
  document.getElementById("role").innerText=user.role ? user.role.toUpperCase() : "";

  document.getElementById("followersCount").innerText=user.followers?.length || 0;
  document.getElementById("followingCount").innerText=user.following?.length || 0;

  updateFollowButton();
  loadPosts();
}

/* ================= LOAD POSTS ================= */

async function loadPosts(){

  const res=await fetch(API+"/api/posts/user/"+userId,{
    headers:{ Authorization:"Bearer "+token }
  });

  const posts=res.ok?await res.json():[];

  document.getElementById("postsCount").innerText = posts.length;

  const container=document.getElementById("userPosts");
  container.innerHTML="";

  posts.forEach(post=>{
    if(post.mediaUrl){
      container.innerHTML+=`
        ${post.mediaType==="video"
          ? `<video src="${post.mediaUrl}" muted></video>`
          : `<img src="${post.mediaUrl}">`}
      `;
    }
  });
}

/* ================= FOLLOW BUTTON ================= */

async function updateFollowButton(){

  if(!token) return;

  const myRes=await fetch(API+"/api/users/me",{
    headers:{ Authorization:"Bearer "+token }
  });

  const me=await myRes.json();

  if(me._id === userId){
    document.getElementById("followBtn").style.display="none";
    return;
  }

  const isFollowing = me.following?.some(f => f === userId);

  const btn=document.getElementById("followBtn");

  if(isFollowing){
    btn.innerText="Following";
    btn.classList.remove("follow-btn");
    btn.classList.add("unfollow-btn");
  }else{
    btn.innerText="Follow";
    btn.classList.remove("unfollow-btn");
    btn.classList.add("follow-btn");
  }
}

/* ================= TOGGLE FOLLOW ================= */

async function toggleFollow(){

  const res = await fetch(API+"/api/users/"+userId+"/follow",{
    method:"PATCH",
    headers:{ Authorization:"Bearer "+token }
  });

  if(!res.ok) return;

  updateFollowButton();
  loadProfile();
}

/* ================= MESSAGE ================= */

function messageUser(){
  window.location.href="employer.html#message="+userId;
}

loadProfile();
</script>

</body>
</html>
