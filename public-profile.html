<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AIFT Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body{background:#f3f2ef;color:#111;}
.layout{
display:grid;
grid-template-columns:300px 1fr 350px;
gap:25px;
max-width:1400px;
margin:40px auto;
padding:0 20px;
}
  /* TOPBAR */
.topbar{
position:fixed;
top:0;
left:0;
width:100%;
height:60px;
background:white;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 30px;
box-shadow:0 2px 10px rgba(0,0,0,0.05);
z-index:1000;
}
.top-left{display:flex;align-items:center;gap:20px;}
.logo{font-weight:700;font-size:20px;color:#0a66c2;}
.search{
padding:8px 15px;
border-radius:20px;
border:1px solid #ddd;
width:250px;
}
.top-right{display:flex;align-items:center;gap:20px;}
.nav-icon{cursor:pointer;font-size:18px;}
.nav-avatar{
width:35px;height:35px;
border-radius:50%;
object-fit:cover;
}
.layout{margin-top:100px;}

/* PANELS */
.panel{
background:white;
border-radius:12px;
box-shadow:0 4px 15px rgba(0,0,0,0.05);
padding:20px;
height:fit-content;
}

/* LEFT PANEL */
.avatar{
width:120px;height:120px;
border-radius:50%;
object-fit:cover;
margin-bottom:15px;
}
.name{
font-size:20px;
font-weight:600;
display:flex;
align-items:center;
gap:8px;
}
.verified{
background:#0a66c2;
color:white;
font-size:11px;
padding:3px 8px;
border-radius:20px;
}
.stat{
font-size:14px;
margin-top:8px;
}
.btn{
margin-top:15px;
padding:8px 18px;
border-radius:20px;
border:none;
font-weight:600;
cursor:pointer;
}
.follow{background:#0a66c2;color:white;}
.unfollow{background:#e4e6eb;}
.message{background:white;border:1px solid #ccc;}

/* CENTER GRID */
.posts-grid{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:8px;
}
.post-item{
position:relative;
overflow:hidden;
cursor:pointer;
border-radius:8px;
background:white;
}

/* SQUARE POSTS (IMAGE / VIDEO) */
.post-item.square{
padding-top:100%;
}

/* TEXT POSTS */
.post-item.text-post{
min-height:220px;
display:flex;
align-items:center;
justify-content:center;
padding:20px;
}
.post-item img,.post-item video{
position:absolute;top:0;left:0;
width:100%;height:100%;
object-fit:cover;
transition:.3s;
}
.post-item:hover img{transform:scale(1.05);}
.overlay{
position:absolute;
top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,0.5);
color:white;
display:flex;
align-items:center;
justify-content:center;
opacity:0;
transition:.3s;
font-weight:600;
}
.post-item:hover .overlay{opacity:1;}

.like-heart{
position:absolute;
top:50%;left:50%;
transform:translate(-50%,-50%);
font-size:60px;
color:white;
opacity:0;
transition:.3s;
pointer-events:none;
}

/* RIGHT PANEL */
.section{margin-bottom:25px;}
.section h4{margin-bottom:10px;}
.skill{
background:#e4e6eb;
padding:6px 12px;
border-radius:20px;
margin:5px 5px 0 0;
display:inline-block;
font-size:13px;
}
.tool-btn{
display:block;
margin-top:8px;
padding:8px;
background:#f3f2ef;
border-radius:8px;
font-size:14px;
cursor:pointer;
transition:.3s;
}
.tool-btn:hover{background:#e4e6eb;}

/* MODAL */
.modal{
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,0.85);
display:none;
align-items:center;
justify-content:center;
z-index:999;
}
.modal-content{
background:white;
max-width:800px;
width:90%;
border-radius:12px;
padding:20px;
}
.modal img,.modal video{width:100%;border-radius:10px;}
.close{cursor:pointer;text-align:right;font-weight:bold;margin-bottom:10px;}

@media(max-width:1200px){
.layout{grid-template-columns:1fr;}
}
  /* ===============================
   PREMIUM MIDDLE PROFILE CARD
================================ */

#middleProfileCard{
  position:sticky;
  top:90px;
  padding:30px;
  border-radius:16px;
  background:linear-gradient(135deg,#0a66c2,#00c897);
  color:white;
  box-shadow:0 15px 40px rgba(0,0,0,0.15);
  overflow:hidden;
  margin-bottom:25px;
  animation:floatCard 6s ease-in-out infinite;
}

/* floating animation */
@keyframes floatCard{
  0%{transform:translateY(0px);}
  50%{transform:translateY(-6px);}
  100%{transform:translateY(0px);}
}

/* soft light effect */
#middleProfileCard::before{
  content:"";
  position:absolute;
  top:-50%;
  left:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), transparent 60%);
  transform:rotate(25deg);
}

.middle-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.middle-header h2{
  font-size:24px;
  font-weight:600;
}

.middle-role-badge{
  background:rgba(255,255,255,0.2);
  padding:6px 12px;
  border-radius:20px;
  font-size:12px;
  letter-spacing:1px;
}

.middle-headline{
  font-size:15px;
  opacity:0.9;
  margin-bottom:20px;
}

.middle-section{
  margin-bottom:15px;
}

.middle-section h4{
  font-size:13px;
  margin-bottom:6px;
  text-transform:uppercase;
  letter-spacing:1px;
  opacity:0.8;
}

#middleExperience div,
#middleEducation div{
  font-size:14px;
  margin-bottom:5px;
}

#middleSkills{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

#middleSkills .skill{
  background:rgba(255,255,255,0.2);
  padding:6px 12px;
  border-radius:20px;
  font-size:12px;
  backdrop-filter:blur(6px);
  transition:.3s;
}

#middleSkills .skill:hover{
  background:white;
  color:#0a66c2;
  transform:scale(1.05);
}
</style>
</head>

<body>

<!-- STATIC TOP NAVBAR -->
<div class="topbar">
  <div class="top-left">
    <div class="logo">AIFT</div>
    <input type="text" placeholder="Search..." class="search">
  </div>

  <div class="top-right">
    <div class="nav-icon">üí¨</div>
    <div class="nav-icon">üîî</div>
    <img id="navAvatar" class="nav-avatar">
  </div>
</div>

<div class="layout">

<!-- LEFT PANEL -->
<div class="panel">
<img id="avatar" class="avatar">
<div class="name" id="name"></div>
<p id="headline"></p>

<div class="stat"><strong id="followers">0</strong> Followers</div>
<div class="stat"><strong id="following">0</strong> Following</div>

<button id="followBtn" class="btn follow" onclick="toggleFollow()">Follow</button>
<button class="btn message" onclick="messageUser()">Message</button>
</div>
<!-- CV PANEL -->
<div class="panel" id="cvPanel" style="display:none;">
  <h4 style="margin-bottom:15px;">Curriculum Vitae</h4>

  <div style="text-align:center;margin-bottom:15px;">
    <img id="cvPhoto" 
         style="width:100px;height:100px;border-radius:50%;object-fit:cover;">
  </div>

  <div id="cvContent" style="font-size:14px;line-height:1.6;"></div>
</div>
<!-- CENTER PANEL -->
<div>

<!-- PROFILE INFO TOP CARD -->
<div id="middleProfileCard">

  <div class="middle-header">
    <h2 id="middleName"></h2>
    <div class="middle-role-badge">AIFT PROFILE</div>
  </div>

  <p id="middleHeadline" class="middle-headline"></p>

  <div class="middle-section">
    <h4>Experience</h4>
    <div id="middleExperience"></div>
  </div>

  <div class="middle-section">
    <h4>Education</h4>
    <div id="middleEducation"></div>
  </div>

  <div class="middle-section">
    <h4>Skills</h4>
    <div id="middleSkills"></div>
  </div>

</div>

  <!-- POSTS -->
  <div id="postsGrid" class="posts-grid"></div>

</div>

<!-- RIGHT PANEL -->
<div class="panel">

<div class="section">
<h4>Activity</h4>
<div id="activitySection"></div>
</div>

<div class="section">
<h4>Experience</h4>
<div id="experienceSection"></div>
</div>

<div class="section">
<h4>Education</h4>
<div id="educationSection"></div>
</div>

<div class="section">
<h4>Skills</h4>
<div id="skillsSection"></div>
</div>

<div class="section">
<h4>Profile Tools</h4>
<div id="toolsSection"></div>
</div>

</div>

</div>

<!-- POST MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div class="close" onclick="closeModal()">X</div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="close" onclick="closeEditModal()">X</div>
    <div id="editModalBody"></div>
  </div>
</div>

<script>
const API="https://backend-1-9b6f.onrender.com";
const token=localStorage.getItem("token");
const params=new URLSearchParams(window.location.search);
const userId=params.get("id");

let profileUser=null;
let loggedUser=null;

/* LOAD PROFILE */
async function loadProfile(){

  const res = await fetch(API + "/api/users/" + userId + "/public");
  profileUser = await res.json();

  document.getElementById("avatar").src =
    profileUser.profileImage ||
    "https://cdn-icons-png.flaticon.com/512/149/149071.png";

  document.getElementById("name").innerHTML =
    profileUser.name +
    (profileUser.isPro ? '<span class="verified">PRO</span>' : "");

  document.getElementById("headline").innerText =
    profileUser.headline || "";
  /* =========================
   MIDDLE PROFILE CARD
   ========================= */

document.getElementById("middleName").innerText =
  profileUser.name;

document.getElementById("middleHeadline").innerText =
  profileUser.headline || "";

/* CLEAR FIRST */
const midExp = document.getElementById("middleExperience");
midExp.innerHTML = "";

const midEdu = document.getElementById("middleEducation");
midEdu.innerHTML = "";

const midSkills = document.getElementById("middleSkills");
midSkills.innerHTML = "";

/* EXPERIENCE */
(profileUser.experience || []).forEach(e=>{
  midExp.innerHTML += `
    <div style="font-size:14px;margin-bottom:6px;">
      <b>${e.title}</b> - ${e.company}
    </div>
  `;
});

/* EDUCATION */
(profileUser.education || []).forEach(e=>{
  midEdu.innerHTML += `
    <div style="font-size:14px;margin-bottom:6px;">
      <b>${e.school}</b> ‚Ä¢ ${e.degree}
    </div>
  `;
});

/* SKILLS */
(profileUser.skills || []).forEach(s=>{
  midSkills.innerHTML += `
    <span class="skill">${s}</span>
  `;
});

  document.getElementById("followers").innerText =
    profileUser.followers?.length || 0;

  document.getElementById("following").innerText =
    profileUser.following?.length || 0;


  /* =========================
     CLEAR BEFORE RE-RENDERING
     ========================= */

  const exp = document.getElementById("experienceSection");
  exp.innerHTML = "";

  const edu = document.getElementById("educationSection");
  edu.innerHTML = "";

  const skills = document.getElementById("skillsSection");
  skills.innerHTML = "";


  /* =========================
     EXPERIENCE
     ========================= */

  (profileUser.experience || []).forEach(e=>{
    exp.innerHTML += `
      <div style="margin-bottom:10px;">
        <b>${e.title}</b> - ${e.company}
      </div>
    `;
  });


  /* =========================
     EDUCATION
     ========================= */

  (profileUser.education || []).forEach(e=>{
    edu.innerHTML += `
      <div style="margin-bottom:10px;">
        <b>${e.school}</b> ‚Ä¢ ${e.degree}
      </div>
    `;
  });


  /* =========================
     SKILLS
     ========================= */

  (profileUser.skills || []).forEach(s=>{
    skills.innerHTML += `
      <span class="skill">${s}</span>
    `;
  });


  /* =========================
     ACTIVITY
     ========================= */

  document.getElementById("activitySection").innerHTML = `
    <div>Joined AIFT</div>
    <div>${profileUser.followers?.length || 0} followers</div>
  `;


  /* =========================
     CV PANEL
     ========================= */

  if(profileUser.cvUrl){

    document.getElementById("cvPanel").style.display = "block";

    document.getElementById("cvPhoto").src =
      profileUser.profileImage ||
      "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    document.getElementById("cvContent").innerHTML = `
      <strong>${profileUser.name}</strong><br>
      ${profileUser.headline || ""}<br><br>

      <strong>Location:</strong> ${profileUser.location || "Not specified"}<br>
      <strong>Email:</strong> ${profileUser.email || ""}<br>
      <strong>Website:</strong> ${profileUser.website || ""}<br><br>

      <strong>Skills:</strong><br>
      ${(profileUser.skills || []).join(", ")}<br><br>

      <a href="${profileUser.cvUrl}" target="_blank"
         style="color:#0a66c2;font-weight:600;">
         Download Full CV
      </a>
    `;
  }


  /* =========================
     OWNER TOOLS
     ========================= */

  if(token){

    const meRes = await fetch(API + "/api/users/me", {
      headers:{ Authorization:"Bearer " + token }
    });

    loggedUser = await meRes.json();

    if(loggedUser._id === userId){

      document.getElementById("followBtn").style.display = "none";

      document.getElementById("toolsSection").innerHTML = `
        <div class="tool-btn" onclick="editPhoto()">Change Profile Photo</div>
        <div class="tool-btn" onclick="addExperience()">Add Experience</div>
        <div class="tool-btn" onclick="addEducation()">Add Education</div>
        <div class="tool-btn" onclick="addSkill()">Add Skill</div>
        <div class="tool-btn" onclick="editHeadline()">Edit Headline</div>
      `;
    }
  }

}

/* LOAD POSTS IG STYLE */
async function loadPosts(){
  try{

    if(!userId){
      console.error("No userId found in URL");
      return;
    }

    const res = await fetch(API + "/api/posts/user/" + userId, {
      headers: token ? { Authorization: "Bearer " + token } : {}
    });

    if(!res.ok){
      console.error("Posts fetch failed:", res.status);
      return;
    }

    const posts = await res.json();

    if(!Array.isArray(posts)){
      console.error("Posts is not an array:", posts);
      return;
    }

    const grid = document.getElementById("postsGrid");
    grid.innerHTML = "";

    if(posts.length === 0){
      grid.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:40px;'>No posts yet</div>";
      return;
    }

 posts.forEach(post => {

  const div = document.createElement("div");
  div.classList.add("post-item");

  const hasMedia = post.mediaUrl || post.image;

  if(hasMedia){

    div.classList.add("square");

    const media = post.mediaType === "video"
      ? `<video src="${post.mediaUrl}" muted></video>`
      : `<img src="${post.mediaUrl || post.image}">`;

    div.innerHTML = `
      ${media}
      <div class="overlay">
        ‚ù§ ${post.likes?.length || 0}
      </div>
      <div class="like-heart">‚ù§</div>
    `;

  } else {

    div.classList.add("text-post");

    div.innerHTML = `
      <div style="font-size:15px;text-align:center;">
        ${post.content || ""}
      </div>
    `;
  }

      /* CLICK = OPEN MODAL */
      div.addEventListener("click", () => openModal(post));

if(loggedUser && loggedUser._id===userId){
const del=document.createElement("div");
del.innerHTML="üóë";
del.style.position="absolute";
del.style.top="10px";
del.style.right="10px";
del.style.cursor="pointer";
del.onclick=(e)=>{
e.stopPropagation();
deletePost(post._id);
};
div.appendChild(del);
}

      /* DOUBLE CLICK = LIKE */
      div.addEventListener("dblclick", () => likePost(post._id, div));

      grid.appendChild(div);
    });

  }catch(error){
    console.error("loadPosts error:", error);
  }
}

/* DOUBLE TAP LIKE */
async function likePost(postId, element){
  try{
    const res = await fetch(API + "/api/posts/" + postId + "/like", {
      method: "PATCH",
      headers: { Authorization: "Bearer " + token }
    });

    if(!res.ok){
      console.error("Like failed");
      return;
    }

    const heart = element.querySelector(".like-heart");

    heart.style.opacity = "1";
    heart.style.transform = "translate(-50%, -50%) scale(1.3)";

    setTimeout(()=>{
      heart.style.opacity = "0";
      heart.style.transform = "translate(-50%, -50%) scale(1)";
    },600);

  }catch(err){
    console.error("Like error:", err);
  }
}

/* MODAL */
function openModal(post){

let content = "";

if(post.mediaUrl || post.image){

  content = post.mediaType==="video"
    ? `<video controls src="${post.mediaUrl}"></video>`
    : `<img src="${post.mediaUrl || post.image}">`;

} else {

  content = `
    <div style="padding:40px;font-size:18px;text-align:center;">
      ${post.content || ""}
    </div>
  `;
}

document.getElementById("modalBody").innerHTML = content;
document.getElementById("modal").style.display="flex";
}
function closeModal(){document.getElementById("modal").style.display="none";}

function toggleFollow(){
fetch(API+"/api/users/"+userId+"/follow",{method:"PATCH",headers:{Authorization:"Bearer "+token}})
.then(()=>location.reload());
}

function messageUser(){
window.location.href="employer.html#message="+userId;
}
function editPhoto(){
alert("Connect to Cloudinary upload modal here");
}

function openEditModal(content){
  document.getElementById("editModalBody").innerHTML = content;
  document.getElementById("editModal").style.display = "flex";
}

function closeEditModal(){
  document.getElementById("editModal").style.display = "none";
}

/* ADD EXPERIENCE */
function addExperience(){
  openEditModal(`
    <h3>Add Experience</h3>
    <input id="expTitle" placeholder="Job Title" style="width:100%;margin:10px 0;padding:8px;">
    <input id="expCompany" placeholder="Company" style="width:100%;margin:10px 0;padding:8px;">
    <button onclick="saveExperience()" class="btn follow">Save</button>
  `);
}

async function saveExperience(){
  const title = document.getElementById("expTitle").value;
  const company = document.getElementById("expCompany").value;

  if(!title || !company) return alert("Fill all fields");

  const updatedExperience = [
    ...(profileUser.experience || []),
    { title, company }
  ];

  await fetch(API+"/api/users/profile",{
    method:"PATCH",
    headers:{
      Authorization:"Bearer "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      experience: JSON.stringify(updatedExperience)
    })
  });

  closeEditModal();
  loadProfile();
}

/* ADD EDUCATION */
function addEducation(){
  openEditModal(`
    <h3>Add Education</h3>
    <input id="eduSchool" placeholder="School" style="width:100%;margin:10px 0;padding:8px;">
    <input id="eduDegree" placeholder="Degree" style="width:100%;margin:10px 0;padding:8px;">
    <button onclick="saveEducation()" class="btn follow">Save</button>
  `);
}

async function saveEducation(){
  const school = document.getElementById("eduSchool").value;
  const degree = document.getElementById("eduDegree").value;

  if(!school || !degree) return alert("Fill all fields");

  const updatedEducation = [
    ...(profileUser.education || []),
    { school, degree }
  ];

  await fetch(API+"/api/users/profile",{
    method:"PATCH",
    headers:{
      Authorization:"Bearer "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      education: JSON.stringify(updatedEducation)
    })
  });

  closeEditModal();
  loadProfile();
}

function addSkill(){
  openEditModal(`
    <h3>Add Skill</h3>
    <input id="skillInput" placeholder="Skill" style="width:100%;margin:10px 0;padding:8px;">
    <button onclick="saveSkill()" class="btn follow">Save</button>
  `);
}

async function saveSkill(){
  const skill = document.getElementById("skillInput").value;
  if(!skill) return alert("Enter skill");

  const updatedSkills = [
    ...(profileUser.skills || []),
    skill
  ];

  await fetch(API+"/api/users/profile",{
    method:"PATCH",
    headers:{
      Authorization:"Bearer "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      skills: JSON.stringify(updatedSkills)
    })
  });

  closeEditModal();
  loadProfile();
}

function editHeadline(){
  openEditModal(`
    <h3>Edit Headline</h3>
    <input id="headlineInput" placeholder="New headline"
      style="width:100%;margin:10px 0;padding:8px;">
    <button onclick="saveHeadline()" class="btn follow">Save</button>
  `);
}

async function saveHeadline(){
  const headline = document.getElementById("headlineInput").value;
  if(!headline) return alert("Enter headline");

  await fetch(API+"/api/users/update-headline",{
    method:"PATCH",
    headers:{
      Authorization:"Bearer "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({headline})
  });

  closeEditModal();
  loadProfile();   // refresh UI without full reload
}
  async function deletePost(postId){
if(!confirm("Delete this post?"))return;
await fetch(API+"/api/posts/"+postId,{
method:"DELETE",
headers:{Authorization:"Bearer "+token}
});
loadPosts();
}
loadProfile();
loadPosts();
</script>

</body>
</html>
