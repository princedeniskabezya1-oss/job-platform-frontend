<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Profile | AIFT</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#f3f2ef;
}

.container{
  max-width:900px;
  margin:40px auto;
}

.card{
  background:white;
  border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);
  overflow:hidden;
  margin-bottom:20px;
}

.banner{
  width:100%;
  height:220px;
  object-fit:cover;
  background:#ddd;
}

.profile-body{
  padding:20px;
  position:relative;
}

.avatar{
  width:150px;
  height:150px;
  border-radius:50%;
  border:4px solid white;
  position:absolute;
  top:-75px;
  left:20px;
  object-fit:cover;
  background:#fff;
}

.profile-info{
  margin-top:90px;
}

.profile-info h2{
  margin:0;
  font-size:24px;
}

.profile-info p{
  margin:6px 0;
  color:#6f6f6f;
}

.stats{
  margin-top:10px;
  font-size:14px;
  color:#444;
}

.stats span{
  font-weight:600;
  margin-right:10px;
  cursor:pointer;
}

.action-buttons{
  margin-top:15px;
  display:flex;
  gap:10px;
}

.btn{
  padding:8px 18px;
  border-radius:20px;
  border:none;
  font-weight:600;
  cursor:pointer;
  font-size:14px;
}

.follow-btn{
  background:#0a66c2;
  color:white;
}

.unfollow-btn{
  background:#e4e6eb;
  color:black;
}

.message-btn{
  background:white;
  border:1px solid #ccc;
}

.post{
  padding:20px;
}

.post img,
.post video{
  width:100%;
  border-radius:10px;
  margin-top:10px;
}

.no-posts{
  text-align:center;
  padding:30px;
  color:#6f6f6f;
}

@media(max-width:768px){
  .avatar{
    width:120px;
    height:120px;
    top:-60px;
  }
  .profile-info{
    margin-top:70px;
  }
}
</style>
</head>

<body>

<div class="container">

<!-- PROFILE CARD -->
<div class="card">
  <img id="banner" class="banner">

  <div class="profile-body">

    <img id="avatar" class="avatar">

    <div class="profile-info">
      <h2 id="name"></h2>
      <p id="headline"></p>
      <p id="role" style="font-weight:600;color:#0a66c2;"></p>
      <p id="bio"></p>

      <div class="stats">
        <span id="followersCount"></span>
        <span id="followingCount"></span>
      </div>

      <div class="action-buttons">
        <button id="followBtn" class="btn follow-btn" onclick="toggleFollow()">
          Follow
        </button>

        <button class="btn message-btn" onclick="messageUser()">
          Message
        </button>
      </div>
    </div>

  </div>
</div>

<!-- EXPERIENCE CARD -->
<div class="card" style="padding:20px;">
  <h3>Experience</h3>
  <div id="experienceSection"></div>
</div>

<!-- EDUCATION CARD -->
<div class="card" style="padding:20px;">
  <h3>Education</h3>
  <div id="educationSection"></div>
</div>

<!-- SKILLS CARD -->
<div class="card" style="padding:20px;">
  <h3>Skills</h3>
  <div id="skillsSection"></div>
</div>

<!-- RESUME CARD -->
<div class="card" style="padding:20px;">
  <h3>Resume</h3>
  <a id="cvLink" target="_blank"></a>
</div>

  <!-- POSTS -->
  <div id="userPosts"></div>

</div>

<script>
const API="https://backend-1-9b6f.onrender.com";
const token=localStorage.getItem("token");

const params=new URLSearchParams(window.location.search);
const userId=params.get("id");

if(!userId) window.location.href="employer.html";

let currentUser=null;

/* LOAD PROFILE */
async function loadProfile(){

  const res=await fetch(API+"/api/users/"+userId+"/public");
  const user=await res.json();
  currentUser=user;

  document.getElementById("banner").src =
    user.bannerImage || "https://via.placeholder.com/900x220";

  document.getElementById("avatar").src =
    user.profileImage || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

  document.getElementById("name").innerText=user.name;
  document.getElementById("headline").innerText=user.headline || "";
  document.getElementById("bio").innerText=user.bio || "";

  document.getElementById("followersCount").innerText =
    (user.followers?.length || 0) + " Followers";

  document.getElementById("followingCount").innerText =
    (user.following?.length || 0) + " Following";
  document.getElementById("role").innerText =
  user.role ? user.role.toUpperCase() : "";

  updateFollowButton();
  // Hide follow button if visiting own profile
if(token){
  const myRes = await fetch(API+"/api/users/me",{
    headers:{ Authorization:"Bearer "+token }
  });

  const me = await myRes.json();

  if(me._id === userId){
    document.getElementById("followBtn").style.display = "none";
  }
}
  // EXPERIENCE
const expContainer = document.getElementById("experienceSection");
expContainer.innerHTML = "";

(user.experience || []).forEach(exp=>{
  expContainer.innerHTML += `
    <div style="margin-bottom:15px;">
      <b>${exp.title}</b> - ${exp.company}<br>
      <span style="font-size:13px;color:#6f6f6f;">
        ${exp.startDate} - ${exp.endDate || "Present"}
      </span>
      <div style="margin-top:5px;">
        ${exp.description || ""}
      </div>
    </div>
  `;
});

// EDUCATION
const eduContainer = document.getElementById("educationSection");
eduContainer.innerHTML = "";

(user.education || []).forEach(edu=>{
  eduContainer.innerHTML += `
    <div style="margin-bottom:10px;">
      <b>${edu.school}</b><br>
      ${edu.degree} â€¢ ${edu.year}
    </div>
  `;
});

// SKILLS
document.getElementById("skillsSection").innerHTML =
  (user.skills || []).map(skill =>
    `<span style="background:#e4e6eb;padding:6px 10px;border-radius:20px;margin:5px;display:inline-block;">${skill}</span>`
  ).join("");

// CV
if(user.cvUrl){
  document.getElementById("cvLink").href = user.cvUrl;
  document.getElementById("cvLink").innerText = "View Resume";
}else{
  document.getElementById("cvLink").innerText = "No resume uploaded";
}
}

/* UPDATE FOLLOW BUTTON */
async function updateFollowButton(){

  const myRes=await fetch(API+"/api/users/me",{
    headers:{ Authorization:"Bearer "+token }
  });

  const me=await myRes.json();

  const isFollowing = me.following?.includes(userId);

  const btn=document.getElementById("followBtn");

  if(isFollowing){
    btn.innerText="Following";
    btn.classList.remove("follow-btn");
    btn.classList.add("unfollow-btn");
  }else{
    btn.innerText="Follow";
    btn.classList.remove("unfollow-btn");
    btn.classList.add("follow-btn");
  }
}

/* TOGGLE FOLLOW */
async function toggleFollow(){

  const res = await fetch(API+"/api/users/"+userId+"/follow",{
    method:"PATCH",
    headers:{ Authorization:"Bearer "+token }
  });

  if(!res.ok){
    alert("Follow failed");
    return;
  }

  const data = await res.json();

  // Update followers count instantly
  document.getElementById("followersCount").innerText =
    data.followers + " Followers";

  updateFollowButton();
  const myRes = await fetch(API+"/api/users/me",{
  headers:{ Authorization:"Bearer "+token }
});
const me = await myRes.json();

if(me._id === userId){
  document.getElementById("followBtn").style.display = "none";
}

/* LOAD POSTS */
async function loadPosts(){

  const res=await fetch(API+"/api/posts/user/"+userId,{
    headers:{ Authorization:"Bearer "+token }
  });

  const posts=res.ok?await res.json():[];

  const container=document.getElementById("userPosts");
  container.innerHTML="";

  if(posts.length===0){
    container.innerHTML=`<div class="card no-posts">No posts yet</div>`;
    return;
  }

  posts.forEach(post=>{
    container.innerHTML+=`
      <div class="card post">
        <div>${post.content || ""}</div>

        ${post.mediaUrl?`
          ${post.mediaType==="video"
            ? `<video controls src="${post.mediaUrl}"></video>`
            : `<img src="${post.mediaUrl}">`}
        `:""}
      </div>
    `;
  });
}

/* MESSAGE USER */
function messageUser(){
  window.location.href="employer.html#message="+userId;
}

loadProfile();
loadPosts();
</script>

</body>
</html>
